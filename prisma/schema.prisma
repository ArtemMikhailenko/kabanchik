generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  clerkId        String          @unique
  email          String
  name           String?
  city           String?
  birthDate      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  role           Role?
  avatar         String?
  bio            String?
  customer       Customer?
  portfolioItems PortfolioItem[]
  pro            Pro?
  reviewsGiven   Review[]        @relation("ReviewsGiven")
  reviewsReceived Review[]       @relation("ReviewsReceived")

  @@map("users")
}

model Pro {
  id         String             @id @default(cuid())
  userId     String             @unique
  isActive   Boolean            @default(true)
  isVerified Boolean            @default(false)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  responses  OrderResponse[]
  orders     Order[]            @relation("SpecialistOrders")
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  profile    SpecialistProfile?

  @@map("pros")
}

model Customer {
  id        String   @id @default(cuid())
  userId    String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders    Order[]  @relation("CustomerOrders")

  @@map("customers")
}

model Category {
  id            String        @id @default(cuid())
  name          String
  nameEn        String?       // English name for internationalization
  description   String?
  slug          String        @unique
  iconColor     String?       // Color for the category icon
  parentId      String?       // For subcategories
  isActive      Boolean       @default(true)
  sortOrder     Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  parent        Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id])
  subcategories Category[]    @relation("CategoryHierarchy")
  orders        Order[]

  @@map("categories")
}

model Order {
  id           String          @id @default(cuid())
  title        String
  description  String
  budget       Decimal?
  location     String?
  categoryId   String
  customerId   String
  specialistId String?
  status       OrderStatus     @default(OPEN)
  views        Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  responses    OrderResponse[]
  review       Review?
  category     Category        @relation(fields: [categoryId], references: [id])
  customer     Customer        @relation("CustomerOrders", fields: [customerId], references: [id])
  specialist   Pro?            @relation("SpecialistOrders", fields: [specialistId], references: [id])

  @@map("orders")
}

model OrderResponse {
  id           String   @id @default(cuid())
  orderId      String
  specialistId String
  message      String
  price        Decimal?
  createdAt    DateTime @default(now())
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  specialist   Pro      @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@unique([orderId, specialistId])
  @@map("order_responses")
}

model SpecialistProfile {
  id              String   @id @default(cuid())
  proId           String   @unique
  bio             String?
  skills          String[]
  categories      String[]
  hourlyRate      Decimal?
  availability    String?
  portfolio       String[]
  rating          Decimal? @default(0)
  reviewCount     Int      @default(0)
  subscriptionPlan String? @default("Basic") // Basic, Pro, Premium
  subscriptionValidUntil DateTime?
  pro             Pro      @relation(fields: [proId], references: [id], onDelete: Cascade)
  subscription    Subscription?

  @@map("specialist_profiles")
}

model Subscription {
  id                    String   @id @default(cuid())
  specialistProfileId   String   @unique
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  stripePriceId         String
  plan                  SubscriptionPlan @default(BASIC)
  status                SubscriptionStatus @default(ACTIVE)
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  specialistProfile     SpecialistProfile @relation(fields: [specialistProfileId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

enum SubscriptionPlan {
  BASIC
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
}

model PortfolioItem {
  id          String   @id @default(cuid())
  userId      String
  image       String
  title       String?
  description String?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("portfolio_items")
}

model Review {
  id           String   @id @default(cuid())
  orderId      String   @unique
  reviewerId   String   // Customer who left the review
  specialistId String   // Specialist being reviewed
  rating       Int      // 1-5 stars
  comment      String?
  isPositive   Boolean  @default(true) // true for positive, false for negative
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reviewer     User     @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  specialist   User     @relation("ReviewsReceived", fields: [specialistId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

enum Role {
  CUSTOMER
  SPECIALIST
}

enum OrderStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
